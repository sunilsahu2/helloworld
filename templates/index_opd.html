{% extends "base.html" %}
{% from "partials/form_sections.html" import render_sections %}
{% set view_mode = selected_opd is not none %}
{% block content %}
    <div class="content-header">
        <div>
            <h2>{{ "View OPD Record" if view_mode else "Create OPD Record" }}</h2>
            <p>
                {% if view_mode %}
                    Viewing OPD record for {{ selected_opd.patient_name or ("OPD #" ~ selected_opd.opd_id) }}.
                {% else %}
                    Complete the OPD registration using the tabs below.
                {% endif %}
            </p>
        </div>
        <div class="search-area">
            <form class="search-form" method="get" action="{{ url_for('index_opd') }}">
                <input name="search" placeholder="Search by name, token, mobile, bill" value="{{ search_query }}">
                <button type="submit">Search</button>
            </form>
{% if search_query and (not selected_opd or (selected_opd and selected_opd.opd_id|string != request.args.get('selected_id'))) %}
                <div class="search-dropdown">
                    {% if search_results %}
                        {% for opd in search_results %}
                            <a
                                class="search-result"
                                href="{{ url_for('index_opd', search=search_query, selected_id=opd.opd_id) }}"
                            >
                                <span class="search-result-name">{{ opd.patient_name or "Unnamed Patient" }}</span>
                                <span class="search-result-meta">Token: {{ opd.opd_token }} | {{ opd.mobile_number or "N/A" }}</span>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="search-no-results">No matches for "{{ search_query }}".</div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    {% if error %}
        <div class="message error">{{ error }}</div>
    {% endif %}
    {% if request.args.get('selected_id') and not selected_opd %}
        <div class="message error">OPD record not found.</div>
    {% elif view_mode and selected_opd %}
        <div class="message success">OPD Record #{{ selected_opd.opd_id }} loaded. Viewing details below.</div>
    {% endif %}
    <form method="post" action="{{ url_for('create_opd') }}" class="{% if view_mode %}readonly{% endif %}" {% if view_mode %}onsubmit="return false;"{% endif %}>
        {{ render_sections(sections, form_data, False, True, view_mode) }}
        <div class="form-actions">
            {% if view_mode %}
                <a class="button-link" href="{{ url_for('index_opd') }}">Clear Selection</a>
                <a class="button-link primary" href="{{ url_for('edit_opd', opd_id=selected_opd.opd_id) }}">Edit OPD Record</a>
            {% else %}
                <button type="submit">Save OPD Record</button>
            {% endif %}
        </div>
    </form>
{% endblock %}

