{% extends "base.html" %}
{% from "partials/form_sections.html" import render_sections %}
{% set view_mode = selected_patient is not none %}
{% block content %}
    <div class="content-header">
        <div>
            <h2>{{ "View Patient" if view_mode else "Create Patient" }}</h2>
            <p>
                {% if view_mode %}
                    Viewing details for {{ selected_patient.full_name or ("Patient #" ~ selected_patient.patient_id) }}.
                {% else %}
                    Complete the patient intake using the tabs below.
                {% endif %}
            </p>
        </div>
        <div class="search-area">
            <form class="search-form" method="get" action="{{ url_for('index') }}">
                <input name="search" placeholder="Search by name, MRN, mobile" value="{{ search_query }}">
                <button type="submit">Search</button>
            </form>
{% if search_query and (not selected_patient or (selected_patient and selected_patient.patient_id|string != request.args.get('selected_id'))) %}
                <div class="search-dropdown">
                    {% if search_results %}
                        {% for patient in search_results %}
                            <a
                                class="search-result"
                                href="{{ url_for('index', search=search_query, selected_id=patient.patient_id) }}"
                            >
                                <span class="search-result-name">{{ patient.full_name or "Unnamed Patient" }}</span>
                                <span class="search-result-meta">MRN: {{ patient.hospital_id }} | {{ patient.mobile_primary or "N/A" }}</span>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="search-no-results">No matches for "{{ search_query }}".</div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    {% if error %}
        <div class="message error">{{ error }}</div>
    {% endif %}
    <form method="post" action="{{ url_for('create_patient') }}" class="{% if view_mode %}readonly{% endif %}">
        {{ render_sections(sections, form_data, False, True, view_mode) }}
        <div class="form-actions">
            {% if view_mode %}
                <a class="button-link" href="{{ url_for('index') }}">Clear Selection</a>
                <a class="button-link primary" href="{{ url_for('edit_patient', patient_id=selected_patient.patient_id) }}">Edit Patient</a>
            {% else %}
                <button type="submit">Save Patient</button>
            {% endif %}
        </div>
    </form>
{% endblock %}

